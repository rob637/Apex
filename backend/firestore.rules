rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================================================
    // Helper Functions
    // ========================================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // ========================================================================
    // Users Collection
    // ========================================================================
    
    match /users/{userId} {
      // Anyone can read user profiles (for leaderboards, etc.)
      allow read: if true;
      
      // Only the user can create/update their own profile
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      
      // Users cannot delete their profile (handled by Cloud Function)
      allow delete: if false;
    }
    
    // ========================================================================
    // Spatial Anchors Collection
    // ========================================================================
    
    match /spatial_anchors/{anchorId} {
      // Anyone can read anchors (needed for AR visualization)
      allow read: if true;
      
      // Only authenticated users can create anchors
      allow create: if isAuthenticated() 
                    && request.resource.data.ownerId == request.auth.uid;
      
      // Only anchor owner can update/delete
      allow update: if isAuthenticated() 
                    && resource.data.ownerId == request.auth.uid;
      allow delete: if isAuthenticated() 
                    && resource.data.ownerId == request.auth.uid;
    }
    
    // ========================================================================
    // Citadels Collection
    // ========================================================================
    
    match /citadels/{citadelId} {
      // Anyone can read citadels
      allow read: if true;
      
      // Only authenticated users can create citadels
      allow create: if isAuthenticated() 
                    && request.resource.data.ownerId == request.auth.uid;
      
      // Owner or guild members can update citadel
      allow update: if isAuthenticated() 
                    && (resource.data.ownerId == request.auth.uid
                        || (resource.data.guildId != null 
                            && getUserData().guildId == resource.data.guildId));
      
      // Only owner can delete citadel
      allow delete: if isAuthenticated() 
                    && resource.data.ownerId == request.auth.uid;
    }
    
    // ========================================================================
    // Guilds Collection
    // ========================================================================
    
    match /guilds/{guildId} {
      // Anyone can read guild info
      allow read: if true;
      
      // Only authenticated users can create guilds
      allow create: if isAuthenticated();
      
      // Only guild leaders can update
      allow update: if isAuthenticated() 
                    && resource.data.leaderId == request.auth.uid;
      
      // Only guild leaders can delete
      allow delete: if isAuthenticated() 
                    && resource.data.leaderId == request.auth.uid;
    }
    
    // ========================================================================
    // Leaderboards Collection (Read-Only, Updated by Cloud Functions)
    // ========================================================================
    
    match /leaderboards/{leaderboardId} {
      allow read: if true;
      allow write: if false; // Only Cloud Functions can write
    }
    
    // ========================================================================
    // Districts & Zones (Read-Only, Seeded by Admin)
    // ========================================================================
    
    match /districts/{districtId} {
      allow read: if true;
      allow write: if false;
    }
    
    match /zones/{zoneId} {
      allow read: if true;
      allow write: if false;
    }
    
    // ========================================================================
    // Battles Collection
    // ========================================================================
    
    match /battles/{battleId} {
      // Participants can read battle
      allow read: if isAuthenticated();
      
      // Only authenticated users can create battles
      allow create: if isAuthenticated();
      
      // Participants can update (submit actions)
      allow update: if isAuthenticated() 
                    && (resource.data.attackerId == request.auth.uid
                        || resource.data.defenderId == request.auth.uid);
      
      // No deletion
      allow delete: if false;
    }
    
    // ========================================================================
    // Resource Nodes (Read-Only, Managed by Cloud Functions)
    // ========================================================================
    
    match /resource_nodes/{nodeId} {
      allow read: if true;
      allow write: if false;
    }
    
    // ========================================================================
    // Territories Collection
    // ========================================================================
    
    match /territories/{territoryId} {
      // Anyone can read territories (for map display)
      allow read: if true;
      
      // Creation/updates handled by Cloud Functions only
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
    
    // ========================================================================
    // Attacks Collection (Battle History)
    // ========================================================================
    
    match /attacks/{attackId} {
      // Participants can read their attacks
      allow read: if isAuthenticated() 
                  && (resource.data.attackerId == request.auth.uid
                      || resource.data.defenderId == request.auth.uid);
      
      // Managed by Cloud Functions
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
    
    // ========================================================================
    // Scheduled Battles Collection
    // ========================================================================
    
    match /scheduled_battles/{battleId} {
      // Participants can read their scheduled battles
      allow read: if isAuthenticated() 
                  && (resource.data.attackerId == request.auth.uid
                      || resource.data.defenderId == request.auth.uid);
      
      // Managed by Cloud Functions
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
    
    // ========================================================================
    // Blueprints Collection (Saved Territory Designs)
    // ========================================================================
    
    match /blueprints/{blueprintId} {
      // Anyone can read blueprints (for restoration)
      allow read: if true;
      
      // Managed by Cloud Functions
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
    
    // ========================================================================
    // Troop Training Subcollection
    // ========================================================================
    
    match /users/{userId}/troop_training/{trainingId} {
      // Only the user can read their training queue
      allow read: if isOwner(userId);
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // User Troops Subcollection
    // ========================================================================
    
    match /users/{userId}/troops/{troopDoc} {
      // Only the user can read their troops
      allow read: if isOwner(userId);
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // Alliances Collection
    // ========================================================================
    
    match /alliances/{allianceId} {
      // Anyone can read alliance info (for searching)
      allow read: if true;
      
      // Managed by Cloud Functions
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
    
    // ========================================================================
    // Alliance Members Subcollection
    // ========================================================================
    
    match /alliances/{allianceId}/members/{memberId} {
      // Alliance members can read membership
      allow read: if isAuthenticated();
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // Alliance Invitations
    // ========================================================================
    
    match /alliance_invitations/{invitationId} {
      // User can read their own invitations
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // Alliance Wars
    // ========================================================================
    
    match /alliance_wars/{warId} {
      // Anyone can read active wars
      allow read: if true;
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // Notifications Collection
    // ========================================================================
    
    match /notifications/{notificationId} {
      // User can only read their own notifications
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      
      // User can mark their own notifications as read
      allow update: if isAuthenticated() 
                    && resource.data.userId == request.auth.uid
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
      
      // Managed by Cloud Functions
      allow create: if false;
      allow delete: if false;
    }
    
    // ========================================================================
    // User FCM Tokens Subcollection
    // ========================================================================
    
    match /users/{userId}/tokens/{tokenId} {
      // Only the user can read/write their tokens
      allow read, write: if isOwner(userId);
    }
    
    // ========================================================================
    // User Achievements Subcollection
    // ========================================================================
    
    match /users/{userId}/achievements/{achievementId} {
      // User can read their own achievements
      allow read: if isOwner(userId);
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // Cooldowns Collection (Attack Cooldowns)
    // ========================================================================
    
    match /cooldowns/{cooldownId} {
      // User can read their own cooldowns
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    // ========================================================================
    // World Events Collection
    // ========================================================================
    
    match /world_events/{eventId} {
      // Anyone can read active world events
      allow read: if true;
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // Event Participation Collection
    // ========================================================================
    
    match /event_participation/{participationId} {
      // Users can read their own participation
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // Seasons Collection
    // ========================================================================
    
    match /seasons/{seasonId} {
      // Anyone can read season info
      allow read: if true;
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // Season Progress Collection
    // ========================================================================
    
    match /season_progress/{progressId} {
      // User can read their own progress
      allow read: if isAuthenticated();
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // Friend Requests Collection
    // ========================================================================
    
    match /friend_requests/{requestId} {
      // Users can read requests they sent or received
      allow read: if isAuthenticated() 
                  && (resource.data.fromUserId == request.auth.uid 
                      || resource.data.toUserId == request.auth.uid);
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // Friendships Collection
    // ========================================================================
    
    match /friendships/{friendshipId} {
      // Users can read their own friendships
      allow read: if isAuthenticated() 
                  && request.auth.uid in resource.data.users;
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // Gifts Collection
    // ========================================================================
    
    match /gifts/{giftId} {
      // Users can read gifts they sent or received
      allow read: if isAuthenticated() 
                  && (resource.data.fromUserId == request.auth.uid 
                      || resource.data.toUserId == request.auth.uid);
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // Social Activities Collection (Activity Feed)
    // ========================================================================
    
    match /social_activities/{activityId} {
      // Anyone can read social activities
      allow read: if true;
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // Chat Channels Collection
    // ========================================================================
    
    match /chat_channels/{channelId} {
      // Anyone can read public channels
      allow read: if true;
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // Chat Messages Collection
    // ========================================================================
    
    match /chat_messages/{messageId} {
      // Anyone can read non-deleted messages
      allow read: if resource.data.isDeleted == false 
                  && resource.data.isHidden == false;
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // Chat Members Collection
    // ========================================================================
    
    match /chat_members/{memberId} {
      // Users can read their own membership
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // Chat Reports Collection
    // ========================================================================
    
    match /chat_reports/{reportId} {
      // Users can read their own reports
      allow read: if isAuthenticated() 
                  && resource.data.reporterId == request.auth.uid;
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // Referral Codes Collection
    // ========================================================================
    
    match /referral_codes/{code} {
      // Anyone can read referral codes (for validation)
      allow read: if true;
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // Referral Uses Collection
    // ========================================================================
    
    match /referral_uses/{useId} {
      // User can read uses involving them
      allow read: if isAuthenticated() 
                  && (resource.data.referrerId == request.auth.uid 
                      || resource.data.referredUserId == request.auth.uid);
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // Analytics Events Collection (Write-only from client)
    // ========================================================================
    
    match /analytics_events/{eventId} {
      // No direct reads
      allow read: if false;
      
      // Authenticated users can write events
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }
    
    // ========================================================================
    // User Sessions Collection
    // ========================================================================
    
    match /user_sessions/{sessionId} {
      // Users can read their own sessions
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // Trust Scores Collection (Hidden from users)
    // ========================================================================
    
    match /trust_scores/{userId} {
      // No direct access
      allow read, write: if false;
    }
    
    // ========================================================================
    // Suspicious Activities Collection (Admin only)
    // ========================================================================
    
    match /suspicious_activities/{activityId} {
      // No direct access
      allow read, write: if false;
    }
    
    // ========================================================================
    // Rate Limits Collection (System only)
    // ========================================================================
    
    match /rate_limits/{limitId} {
      // No direct access
      allow read, write: if false;
    }
    
    // ========================================================================
    // Map Tiles Collection (Read-only for clients)
    // ========================================================================
    
    match /map_tiles/{tileId} {
      // Anyone can read map tiles
      allow read: if true;
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // Map Activities Collection
    // ========================================================================
    
    match /map_activities/{activityId} {
      // Anyone can read recent activities
      allow read: if true;
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // Player Locations Collection
    // ========================================================================
    
    match /player_locations/{locationId} {
      // Users can read nearby players
      allow read: if isAuthenticated();
      
      // Users can update their own location
      allow write: if isAuthenticated() 
                   && request.resource.data.userId == request.auth.uid;
    }
    
    // ========================================================================
    // Location History Collection (Hidden from users)
    // ========================================================================
    
    match /location_history/{userId} {
      // No direct access
      allow read, write: if false;
    }
    
    // ========================================================================
    // Daily Active Users Collection (System only)
    // ========================================================================
    
    match /daily_active_users/{date} {
      // No direct access
      allow read, write: if false;
    }
    
    // ========================================================================
    // Daily Metrics Collection (Admin only)
    // ========================================================================
    
    match /daily_metrics/{date} {
      // No direct access
      allow read, write: if false;
    }
    
    // ========================================================================
    // A/B Tests Collection (Admin only)
    // ========================================================================
    
    match /ab_tests/{testId} {
      // No direct access
      allow read, write: if false;
    }
    
    // ========================================================================
    // A/B Test Assignments Collection
    // ========================================================================
    
    match /ab_test_assignments/{assignmentId} {
      // Users can read their own assignments
      allow read: if isAuthenticated();
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // User Warnings Collection
    // ========================================================================
    
    match /user_warnings/{warningId} {
      // Users can read their own warnings
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      
      // Users can acknowledge their warnings
      allow update: if isAuthenticated() 
                    && resource.data.userId == request.auth.uid
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['acknowledged']);
      
      // Managed by Cloud Functions
      allow create, delete: if false;
    }
    
    // ========================================================================
    // Viral Challenges Collection
    // ========================================================================
    
    match /viral_challenges/{challengeId} {
      // Anyone can read active challenges
      allow read: if true;
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // Viral Challenge Progress Collection
    // ========================================================================
    
    match /viral_challenge_progress/{progressId} {
      // Users can read their own progress
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // Share Rewards Collection
    // ========================================================================
    
    match /share_rewards/{rewardId} {
      // Users can read their own share rewards
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // Heatmap Data Collection
    // ========================================================================
    
    match /heatmap_data/{dataId} {
      // Anyone can read heatmap data
      allow read: if true;
      
      // Managed by Cloud Functions
      allow write: if false;
    }
    
    // ========================================================================
    // Purchases Collection (IAP)
    // ========================================================================
    
    match /purchases/{purchaseId} {
      // Users can read their own purchases
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      
      // Purchases are created/managed by Cloud Functions only
      // This prevents users from faking purchases
      allow write: if false;
    }
    
    // ========================================================================
    // Entitlements Collection (IAP)
    // ========================================================================
    
    match /entitlements/{entitlementId} {
      // Users can read their own entitlements
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      
      // Entitlements are created/managed by Cloud Functions only
      allow write: if false;
    }
    
    // ========================================================================
    // VIP Deliveries Collection (IAP)
    // ========================================================================
    
    match /vip_deliveries/{deliveryId} {
      // Users can read their own VIP deliveries
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      
      // Managed by Cloud Functions only
      allow write: if false;
    }
    
    // ========================================================================
    // Purchase Failures Collection (IAP - Admin/Debug)
    // ========================================================================
    
    match /purchase_failures/{failureId} {
      // Only Cloud Functions can access
      allow read, write: if false;
    }
    
    // ========================================================================
    // Apple Notifications Collection (IAP Webhooks)
    // ========================================================================
    
    match /apple_notifications/{notificationId} {
      // Only Cloud Functions can access
      allow read, write: if false;
    }
    
    // ========================================================================
    // Products Collection (IAP Catalog)
    // ========================================================================
    
    match /products/{productId} {
      // Anyone can read products (for store display)
      allow read: if true;
      
      // Only Cloud Functions can manage products
      allow write: if false;
    }
    
    // ========================================================================
    // Notification Settings Collection
    // ========================================================================
    
    match /notification_settings/{userId} {
      // Users can read/update their own notification settings
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if isAuthenticated() && isOwner(userId);
    }
    
    // ========================================================================
    // Notification Logs Collection
    // ========================================================================
    
    match /notification_logs/{logId} {
      // Users can read their own notification logs
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      
      // Only Cloud Functions can write
      allow write: if false;
    }
    
    // ========================================================================
    // Broadcast Logs Collection (Admin)
    // ========================================================================
    
    match /broadcast_logs/{logId} {
      // Only Cloud Functions can access
      allow read, write: if false;
    }
    
    // ========================================================================
    // Scheduled Notifications Collection
    // ========================================================================
    
    match /scheduled_notifications/{notificationId} {
      // Only Cloud Functions can access
      allow read, write: if false;
    }
    
    // ========================================================================
    // Tutorial Progress Collection
    // ========================================================================
    
    match /tutorial_progress/{progressId} {
      // Users can read/write their own tutorial progress
      allow read, write: if isAuthenticated() 
                        && resource.data.userId == request.auth.uid;
    }
  }
}