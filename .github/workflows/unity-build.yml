name: Unity Build

on:
  push:
    branches: [main, develop]
    paths:
      - 'unity/ApexCitadels/**'
      - '.github/workflows/unity-build.yml'
  pull_request:
    branches: [main]
    paths:
      - 'unity/ApexCitadels/**'
  workflow_dispatch:
    inputs:
      buildAndroid:
        description: 'Build Android APK'
        required: false
        default: true
        type: boolean
      buildIOS:
        description: 'Build iOS (Xcode project)'
        required: false
        default: false
        type: boolean

env:
  UNITY_VERSION: '6000.3.3f1'
  PROJECT_PATH: unity/ApexCitadels

jobs:
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.buildAndroid }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: ${{ env.PROJECT_PATH }}/Library
          key: unity-library-android-${{ hashFiles('unity/ApexCitadels/Assets/**', 'unity/ApexCitadels/Packages/**', 'unity/ApexCitadels/ProjectSettings/**') }}
          restore-keys: |
            unity-library-android-

      - name: Build Android APK
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          projectPath: ${{ env.PROJECT_PATH }}
          targetPlatform: Android
          buildName: ApexCitadels
          androidAppBundle: false
          androidKeystoreName: user.keystore
          androidKeystoreBase64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          androidKeystorePass: ${{ secrets.ANDROID_KEYSTORE_PASS }}
          androidKeyaliasName: ${{ secrets.ANDROID_KEYALIAS_NAME }}
          androidKeyaliasPass: ${{ secrets.ANDROID_KEYALIAS_PASS }}
          customParameters: -define:FIREBASE_ENABLED

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/Android/*.apk
          retention-days: 14

  build-ios:
    name: Build iOS
    runs-on: macos-latest
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.buildIOS }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: ${{ env.PROJECT_PATH }}/Library
          key: unity-library-ios-${{ hashFiles('unity/ApexCitadels/Assets/**', 'unity/ApexCitadels/Packages/**', 'unity/ApexCitadels/ProjectSettings/**') }}
          restore-keys: |
            unity-library-ios-

      - name: Build iOS Xcode Project
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          projectPath: ${{ env.PROJECT_PATH }}
          targetPlatform: iOS
          buildName: ApexCitadels
          customParameters: -define:FIREBASE_ENABLED

      - name: Upload iOS Build
        uses: actions/upload-artifact@v4
        with:
          name: ios-xcode-project
          path: build/iOS/
          retention-days: 14

  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [build-android]
    if: always()
    
    steps:
      - name: Build Status Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.build-android.result }}" == "success" ]; then
            echo "✅ Android build succeeded" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Android build failed: ${{ needs.build-android.result }}" >> $GITHUB_STEP_SUMMARY
          fi
